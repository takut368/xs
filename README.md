# README (ストーリー作成サイト)

本リポジトリは、Instagram風のストーリーを作成・管理・閲覧するWebアプリケーションのサンプルコード一式です。  
管理者がアカウントを作成し、アカウントごとにストーリー（画像・動画）を追加・編集・削除でき、一般ユーザーはログイン不要でストーリーを閲覧できます。

---

## 1. ディレクトリ構造

以下は、このストーリー作成サイトが想定するディレクトリ構造の例です。

```
instagran.azurewebsites.net/
├── .htaccess
├── index.php
├── admin.php
├── account.json
├── system.json
├── data/
│   ├── data_XXXXXX/
│   │   ├── data.json
│   │   └── ...
│   └── ...
├── uploads/
│   ├── icons/
│   │   └── ... (アカウントアイコン画像)
│   └── stories/
│       ├── XXXXXX/
│       │   ├── story_XXXXXX.jpg
│       │   ├── story_XXXXXX.mp4
│       │   └── ...
│       └── ...
└── ...
```

- **`.htaccess`**  
  - ApacheのURLリライト設定ファイル。  
  - `https://instagran.azurewebsites.net/XXXXXX` へのアクセスを `index.php?account=XXXXXX` へ内部リダイレクトします。

- **`index.php`**  
  - ストーリー閲覧用ページ。  
  - `.htaccess` により `?account=XXXXXX` が付与されたアクセスを受け取り、Instagram風のUIでストーリーを表示します。

- **`admin.php`**  
  - 管理画面。  
  - 管理者ログインやアカウント管理、ストーリーの作成・編集・削除、アクセス解析などを提供します。

- **`account.json`**  
  - 管理者および各アカウント・ストーリーの情報をJSON形式で保持します。

- **`system.json`**  
  - システム管理者や管理者レベルなどを保持し、管理者の監督機能を実現します。

- **`data/`**  
  - ストーリーごとの閲覧数 (`access_count`) と遷移数 (`redirect_count`) などを格納する領域。  
  - `data/XXXXXX/data.json` のようにアカウントIDごとにディレクトリを作り、数字を保存します。

- **`uploads/`**  
  - 画像や動画などアップロードされたファイルを格納する領域。  
  - `uploads/icons/` 配下にアカウントアイコン、`uploads/stories/XXXXXX/` 配下にストーリーファイルを保存します。
  - サーバーへの書き込み権限を正しく設定し、不正アクセスを防ぐためにもセキュリティ設定に注意してください。

---

## 2. セットアップ

1. **ApacheでRewriteを有効化**  
   - `.htaccess` が機能するよう、Apacheの設定で `mod_rewrite` を有効にしてください。
   - `.htaccess` 内で `RewriteEngine On` と設定済みなので、サーバーが `.htaccess` を読み込むようにしておきます。

2. **ファイル配置**  
   - `admin.php`, `index.php`, `.htaccess`, `account.json`, `system.json` を同じディレクトリに配置します。
   - `uploads/` と `data/` ディレクトリを作成し、書き込み可能なパーミッションに設定してください。

3. **初回アクセス**  
   - ブラウザで `admin.php` にアクセスすると、ログイン画面が表示されます。
   - もし初期管理者がいない場合は自動的に `admin` / `admin` で作成されます。
   - ログイン成功後、パスワード未変更なら変更画面が表示されるので、新しいID/パスワードを設定してください。

---

## 3. 使い方

### ストーリー閲覧

- 一般ユーザーは `https://instagran.azurewebsites.net/XXXXXX` にアクセスするだけでストーリーを閲覧できます。  
- `.htaccess` により `index.php?account=XXXXXX` に内部リダイレクトされ、`index.php` 側で該当アカウントのストーリーをInstagram風UIで表示します。  
- 上部には10秒間のプログレスバー、右上にバツボタン、左上にはアカウントのアイコンとIDを表示できます。  
- ストーリーは画像・動画の両方に対応し、10秒ごとに自動で次のストーリーへ切り替わります。  

### 管理者機能

1. **ログイン**  
   - `admin.php` にアクセスし、管理者ID・パスワードでログインします。  
   - 初回ログイン時はパスワード変更を強制されます。

2. **アカウント作成・編集・削除**  
   - アカウント名・アイコン画像を設定し、`account.json` に反映。  
   - アカウント削除時にはストーリーや画像ファイルもまとめて削除されます。

3. **ストーリー作成・編集・削除**  
   - 作成時に画像or動画ファイルをアップロードして9:16などの比率に整形。  
   - 編集でURL、テキスト、画像/動画を更新。  
   - 削除時にはファイルをサーバーから除去し、JSONも更新。

4. **リンク位置設定**  
   - ストーリー画像上でクリックされた位置を取得し、その比率をJSONに格納。  
   - 閲覧画面で指定座標にテキストリンクを表示し、タップすると内部リダイレクトでリンク先に飛ばします。

5. **アクセス解析 (stats機能)**  
   - `?stats=1` を付けて `admin.php` にアクセスすると、ストーリーごとの閲覧数・遷移数を一覧表示します。  
   - `data/XXXXXX/data.json` に数値が保存され、管理者画面で可視化できます。

6. **リダイレクト機能**  
   - ストーリー内リンクをタップすると `?redirect_account=&redirect_story=` へアクセス → リダイレクト数をカウントし、本来のURLへ即時転送します。

---

## 4. 留意事項

- **セキュリティ**  
  - 本番運用の場合はID/パスワードのハッシュ化やHTTPS運用が必須です。  
  - JSONファイルやアップロードフォルダは外部から直接参照されないよう、適切な権限設定やセキュリティ対策を行ってください。

- **運用・保守**  
  - `account.json`, `system.json`, `data/`, `uploads/` を定期バックアップしてください。  
  - 画像/動画が増えすぎる場合は古いものをアーカイブするなど運用ルールを設けましょう。

- **拡張性**  
  - 日別・月別のアクセス集計、マルチ管理者運用などが追加要望として考えられます。  
  - GitなどでコードやJSONのバージョン管理を行うと、保守・運用がしやすくなります。

以上が本システムのREADMEです。詳細な要件は **「要件定義書」** を参照してください。
