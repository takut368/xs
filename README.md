# サムネイル付きリンク生成サービス

このプロジェクトは、ユーザーが指定したURLへのリンクを生成し、そのリンクにサムネイル画像などのメタ情報を付与するウェブサービスです。  
本サービスを使用することで、TwitterやSNSでシェアした際に、見栄えの良いサムネイル付きのリンクを生成できます。

---

## 特徴

1. **サムネイル画像の選択方法を3種類サポート**  
   - **画像URLを入力**：外部からの画像URLを指定可能  
   - **画像ファイルをアップロード**：ローカルPCやスマートフォンから直接アップロード  
   - **テンプレートから選択**：あらかじめ用意した画像テンプレートから選択  

2. **レスポンシブデザイン対応**  
   - スマホの縦画面でもPCでも、綺麗に表示されるUIを実現

3. **CSRF対策・セキュリティ強化**  
   - フォーム送信時にCSRFトークンを使用して、不正なリクエストを防止

4. **リンク生成形式の向上**  
   - 生成されたリンクを「`ドメイン/ユニークID/`」というフォルダ形式にし、`.html`拡張子を隠蔽  
   - よりシンプルで美しいURLを実現

5. **メタタグ対応**  
   - Twitterカード等、SNSでのプレビューが自動で表示されるようメタタグを自動生成

6. **画像プレビュー機能**  
   - クライアント側（ブラウザ）でCanvas APIを用いて画像を2:1にトリミングし、プレビュー表示

---

## 動作環境

- **PHP** 7.4 以上
  - **GDライブラリ**：画像処理のため必須
  - **cURL**：画像URLからの取得に使用
- **Webサーバー** (Apache / Nginx / IIS など)
- **SSL証明書** (推奨)  
  - HTTPSで通信することでセキュリティを確保

---

## ディレクトリ構成

```
wwwroot/
├── index.php            // メインとなるファイル
├── uploads/             // アップロードした画像や編集された画像を保存
│   └── (generated images)
├── temp/                // テンプレート画像などを格納
│   ├── live_now.png
│   ├── nude.png
│   ├── gigafile.jpg
│   ├── ComingSoon.png
│   └── saisei_button.png (使用する場合)
└── (生成されるユニークフォルダ)/
    └── index.php        // リダイレクト用のファイル
```

- `index.php`  
  メインのフォーム画面とバックエンド処理を担当します。  
- `uploads/`  
  ユーザーがアップロードした画像ファイルや、編集後の画像ファイルを保存するディレクトリです。  
- `temp/`  
  テンプレート画像などを保存するディレクトリです。  

---

## セットアップ手順

1. **サーバー環境の準備**  
   - PHP 7.4以上をインストールしてください。  
   - Webサーバー（Apache, Nginxなど）を設定します。  

2. **プロジェクトの配置**  
   - 上記のディレクトリ構成に合わせて、ファイルを配置してください。  
   - `uploads/` ディレクトリは書き込み可能（`777`など）にしてください。  

3. **テンプレート画像の配置**  
   - `temp/` ディレクトリに、サムネイルに使用する画像（`live_now.png` など）を配置してください。  

4. **ファイルのパーミッション設定**  
   - `uploads/` は書き込み可能に設定（例: `chmod 777 uploads/`）。  
   - `temp/` は読み取り可能に設定。  

5. **動作確認**  
   - ブラウザで `index.php` にアクセスし、フォームが正しく表示されるか確認してください。  
   - 画像のアップロードやURL指定が正しく動作するかテストしてください。  

---

## 使い方

1. **フォームに必要事項を入力**  
   - **遷移先URL**：リンク先となるサイトのURL  
   - **タイトル**：リンクのタイトル  
   - **サムネイル画像の選択**  
     1. **画像URLを入力**： 外部URLを入力  
     2. **画像ファイルをアップロード**： ローカルファイルを選択  
     3. **テンプレートから選択**： ポップアップでテンプレートを選択  
   - **詳細設定**（任意）  
     - ページの説明  
     - Twitterアカウント名（@含む）  
     - 画像の代替テキスト  

2. **プレビュー確認**  
   - 画像ファイルやURLを指定した場合、クライアント側で2:1のアスペクト比にトリミングしたプレビューを確認。  

3. **リンク生成ボタンをクリック**  
   - 必須項目が入力されている場合、リンク生成に成功。  
   - ユニークなフォルダ（`uniqid()`）を作成し、その中に `index.php` を生成。  

4. **生成されたリンクをコピー**  
   - 生成されたリンクのURLが表示されるので、コピーボタンでクリップボードにコピー。  

5. **リンク確認**  
   - 生成されたリンクにアクセスすると、自動で指定したURLへリダイレクトされる。  
   - Twitterやその他SNSでシェアすると、設定したサムネイル画像が表示される。  

---

## セキュリティについて

1. **CSRF対策**  
   - フォームにCSRFトークンを埋め込み、サーバー側で検証。  
   - 外部からの不正なリクエストを排除。  

2. **入力データのサニタイズ**  
   - `filter_input` や `htmlspecialchars` を活用してXSSを防止。  

3. **ファイルアップロードの制限**  
   - `uploads/` ディレクトリに対して適切なパーミッションを設定。  
   - ファイルの種類（拡張子）やサイズを制限。  

4. **ユニークなフォルダ名の使用**  
   - `uniqid()` を用いて、衝突しないディレクトリ名を生成。  
   - 予測が困難なフォルダ名により不正アクセスリスクを低減。  

---

## よくある質問（FAQ）

1. **Q: Twitterカードが表示されない場合は？**  
   **A:** Twitterカードの有効化や、URLが正しく設定されているかをご確認ください。Twitterにはキャッシュがあるため、[Card Validator](https://cards-dev.twitter.com/validator) で確認すると良いでしょう。

2. **Q: 画像が正しく表示されない場合は？**  
   **A:**  
   - CORSエラーでブロックされていないか確認してください。  
   - 画像URLやアップロードファイルの拡張子が正しいか確認してください。  

3. **Q: 生成されたリンク先を変更したい場合は？**  
   **A:** 生成されたフォルダ内の `index.php` を直接編集するか、再度フォームから新しいリンクを生成してください。

---

## ライセンス

- 本プロジェクトは MIT ライセンスの下で提供されることを想定しています。  
- 実際に公開される際は、必要に応じてライセンス表記をご準備ください。

---

## 開発者向け情報

- **拡張機能**  
  - 画像を2:1以外のアスペクト比で処理したい場合、`loadImageAndCrop()` 関数を修正して対応可能です。  
  - テンプレート画像を増やす場合は `temp/` フォルダに画像を追加し、 `index.php` の `$templates` 配列にファイル名を追加してください。  

- **デプロイ方法**  
  1. ソースコードをサーバーにアップロード  
  2. `uploads/` フォルダの書き込み権限を設定  
  3. `temp/` フォルダにテンプレート画像を配置  
  4. ブラウザでアクセスし動作を確認  

- **ログおよびエラーハンドリング**  
  - 本番環境では `display_errors` を `Off` にし、`error_log` に出力することを推奨します。  
  - CSRFエラーやファイルアップロードエラーなどはユーザーに簡潔なメッセージを表示し、詳細はログに記録してください。  

以上で、**サムネイル付きリンク生成サービス**のREADMEとなります。ご不明点や改善案等ございましたら、適宜ご連絡ください。
